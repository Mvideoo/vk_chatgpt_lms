import os
import asyncio
import aiohttp
from dotenv import load_dotenv
from models import ChatRequest

load_dotenv()
API_URL = "https://api.openai.com/v1/chat/completions"
# API_KEY = os.getenv("OPENAI_API_KEY")
API_KEY = "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"


async def generate_description(data: ChatRequest) -> str:
    # Формируем prompt (как было)
    prompt = (
        "Есть несколько историй персонажей:\n"
        "ID: 1 - Евдокия Дашина — зоолог, сотрудница Ленинградского зоопарка, спасла бегемотиху, ежедневно носила ей воду и ухаживала за ней 872 дня.\n"
        "ID: 2 - Иван Середа — повар, во время Великой Отечественной войны в одиночку захватил немецкий танк и взял в плен четырёх членов экипажа.\n"
        "ID: 3 - Иван Зубков — руководитель метростроения, возглавил строительство железной дороги по льду Ладожского озера, что помогло снабжению Ленинграда.\n"
        "ID: 4 - Макар Мазай — металлург, с 1930 года работал на Мариупольском заводе. Во время войны отказался сотрудничать с нацистами и был ими расстрелян.\n"
        "ID: 5 - Владимир Басов — актёр и режиссёр, в годы войны был артиллеристом, командовал миномётной батареей, организовал на фронте кружок художественной самодеятельности.\n"
        "ID: 6 - Борис Полевой — писатель и фронтовой корреспондент, освещал Нюрнбергский процесс, автор «Повести о настоящем человеке», был редактором журнала «Юность».\n"
        "ID: 7 - Дмитрий Тяпин — колхозник. Спас боевое знамя 24-й стрелковой дивизии, за что был навечно зачислен в списки дивизии. Награждён Георгиевскими крестами и медалью «За храбрость».\n"
        "ID: 8 - Сергей Маслих — архитектор, автор типовых двухэтажных домов, по чьим проектам после войны быстро восстанавливали разрушенные города СССР.\n"
        "ID: 9 - Евгений Патон — мостостроитель и учёный, разработал технологию автоматической сварки брони для танков Т-34. Автор проектов более 100 мостов.\n"
        "ID: 10 - Лидия Русланова — фронтовая певица, дала 1120 концертов за годы войны, дошла с армией до Берлина, пожертвовала сбережения на «Катюши».\n"
        "ID: 11 - Пётр Заводчиков — кинолог, руководил школой служебного собаководства в Ленинграде, формировал армейские отряды собак для поиска мин и уничтожения танков в годы войны.\n"
        "ID: 12 - Татьяна Бревнова, медник, работала на танковом заводе, с 16 лет была бригадиром, ее бригада перевыполняла план до 1480% и получила переходящее Красное знамя.\n"
        "ID: 13 - Алексей Семиволос — бурильщик. За 1943 год выполнил 3,5 годовых нормы, ставил рекорды в добыче руды. В годы войны трудился на Урале, затем восстанавливал шахты.\n"
        "ID: 14 - Борис Филиппов — директор театра, руководитель первой актёрской бригады, выступавшей на фронте в годы войны, организовывал выступления артистов для поддержки бойцов.\n"
        "ID: 15 - Григорий Коваленко — легендарный кузнец Уралмашзавода, изготавливал детали для Т-34, выполнял до 400% нормы.\n"
        "ID: 16 - Мария Байда — санитарка, в 19 лет уничтожила 16 фашистов, освободила пленных, воевала под Севастополем.\n"
        "ID: 17 - Андрей Бочвар, металловед, создал цинковистый силумин, что ускорило выпуск военной техники в годы войны.\n"
        "ID: 18 - Евгений Важинский — главный конструктор советского грузовика ЗИС-5, ставшего важнейшим автомобилем Красной армии.\n"
        "ID: 19 - Карл Элиасберг — дирижёр, организовал исполнение 7-й симфонии Шостаковича в блокадном Ленинграде в 1942 году.\n"
        "ID: 20 - Николай Веревичев — начальник картографической части, в 1943 году создал подробный план Берлина для штурма.\n"
        "ID: 21 - Александр Александров — композитор, автор музыки к «Священной войне», самой значимой песне Великой Отечественной войны.\n"
        "ID: 22 - Владимир Галл — переводчик, убедивший капитулировать гарнизон крепости Шпандау в 1945 году без единого выстрела.\n"
        "ID: 23 - Зинаида Ермольева — эпидемиолог, создала советский антибиотик, остановила эпидемии, спасла раненых, снизила смертность на фронте.\n"
        "ID: 24 - Пётр Черпаков — механик-тракторист, в войну ремонтировал танки под огнём, награждён орденами и медалями.\n"
        "ID: 25 - Елена Чухнюк — первая женщина-машинист, Герой Социалистического Труда, водила поезда на фронт во время войны.\n"
        "ID: 26 - Сергей Королёв — ракетостроитель, в войну создавал аэроторпеду и авиабомбу, позже стал главным конструктором ракет СССР.\n"
        "ID: 27 - Павел Лукьяненко — селекционер, в годы войны вывел урожайные сорта озимой пшеницы, давшие миллионы пудов хлеба.\n"
        "ID: 28 - Ферапонт Головатый — пасечник из Саратовской области, пожертвовал сбережения на три истребителя для фронта в войну.\n"
        "ID: 29 - Гурий Ястребов — директор «Артека», эвакуировал более 200 детей из Крыма на Алтай, смена длилась 1301 день.\n"
        "ID: 30 - Сергей Бернштейн — математик, создал таблицы для обнаружения вражеских кораблей, повысив эффективность советского флота в войне.\n"
        "ID: 31 - Анна Щетинина — первая в мире женщина-капитан дальнего плавания, водила ленд-лизовские грузы, участвовала в войне.\n"
        "ID: 32 - Сергей Ильюшин — авиаконструктор, создатель штурмовика Ил-2, самого массового и эффективного самолёта Великой Отечественной войны.\n"
        "ID: 33 - Михаил Бобров — альпинист, маскировал высоты Ленинграда во время блокады, чтобы защитить город от бомбёжек.\n"
        "ID: 34 - Михаил Кошкин — создатель и первый главный конструктор советского танка Т-34, символа Победы.\n"
        "ID: 35 - Мстислав Келдыш — инженер-аэродинамик, решивший во время войны проблемы флаттера и шимми, спасая сотни самолётов.\n"
        "ID: 36 - Юрий Левитан — главный диктор СССР, символ Победы, объявил о ней в 1945, умер в 1983 году.\n"
        "ID: 37 - Татьяна Петрухина — фронтовая прачка, в 17 лет добровольно стирала для армии, прошла Россию, Белоруссию, Польшу, Германию.\n"
        "ID: 38 - Василий Шубин — инструментальщик ГАЗа, инициатор фронтовых бригад, установил рекорд: 25 норм за смену.\n"
        "ID: 39 - Лев Галашин — волжский капитан, в Великую Отечественную войну эвакуировал из Сталинграда до 20 000 человек.\n"
        "ID: 41 - Фёдор Сацыперов — ботаник, исследовал свойства мха сфагнума для лечения ран, разработал стандарты лекарственного сырья.\n"
        "ID: 42 - Григорий Нестеров — артиллерист и дрессировщик верблюдов, дошёл с ними до Берлина, участвовал во взятии Рейхстага.\n"
        "ID: 43 - Дмитрий Овчаренко - плотник, в 1941 году уничтожил 23 фашистов с топором, стал Героем Советского Союза.\n"
        "ID: 44 - Пётр Горюнов — слесарь-самоучка, создатель первого советского станкового пулемёта, заменившего «Максим» в годы войны.\n"
        "ID: 45 - Сергей Борзенко — военный корреспондент, единственный журналист Герой Советского Союза в ВОВ, командовал десантом у Керчи.\n"
        "ID: 46 - Софья Оникиенко, директор библиотеки Воронежа, спасла тысячи редких книг, похищенных фашистами во время войны.\n"
        "ID: 47 - Матвей Фролов — радиожурналист из блокадного Ленинграда, первым рассказал миру о дневнике Тани Савичевой.\n"
        "ID: 48 - Василий Монахов — инженер, за 5 дней создал проект «Дороги жизни» через Ладожское озеро в блокадный Ленинград.\n"
        "ID: 49 - Владимир Энгельгардт — биохимик, разработал получение витамина С из зелёных грецких орехов, спас солдат от цинги.\n"
        "Одному человеку задали вопросы, и он ответил так:\n\n"
    )
    for item in data.answers:
        prompt += f"Q: {item.question}\nA: {item.answer}\n\n"
    prompt += (
        "Определи, кем из персонажей был человек и напиши короткое обоснование.(в ответе не используй никаких"
        " символов по типа '*' и т.д Только текст и знаки препинания)\n"
        "Формат ответа: ID(только число, без всего остального) — Описание(до 200 символов, в описании необходимо обосновать чем человек схож с героем прошлого, отсыпайся к ответам пользователя и конкретизируй свой ответ, чтобы у пользователя возникла личная связь с историей героя. Пиши так, будто ты"
        " обращаешься к пользователю лично)"
    )

    headers = {
        "Authorization": f"Bearer {API_KEY}",
        "Content-Type": "application/json",
    }
    payload = {
        "model": "gpt-4o",
        "messages": [{"role": "user", "content": prompt}],
    }

    # Простой вызов без верификации SSL:
    async with aiohttp.ClientSession() as session:
        async with session.post(API_URL, headers=headers, json=payload, ssl=False) as resp:
            resp.raise_for_status()
            result = await resp.json()

    return result["choices"][0]["message"]["content"].strip()
